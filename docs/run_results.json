{"metadata": {"dbt_schema_version": "https://schemas.getdbt.com/dbt/run-results/v6.json", "dbt_version": "1.8.2", "generated_at": "2024-07-18T11:58:54.745602Z", "invocation_id": "98d9424a-b907-4311-a1d7-89238d3ffa27", "env": {}}, "results": [{"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-18T11:58:52.228399Z", "completed_at": "2024-07-18T11:58:52.236358Z"}, {"name": "execute", "started_at": "2024-07-18T11:58:52.237311Z", "completed_at": "2024-07-18T11:58:52.237311Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009901762008666992, "adapter_response": {}, "message": null, "failures": null, "unique_id": "seed.sql_dynamic_rename.rename_sample_data", "compiled": null, "compiled_code": null, "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-18T11:58:52.241993Z", "completed_at": "2024-07-18T11:58:52.246940Z"}, {"name": "execute", "started_at": "2024-07-18T11:58:52.247941Z", "completed_at": "2024-07-18T11:58:52.247941Z"}], "thread_id": "Thread-3 (worker)", "execution_time": 0.007970094680786133, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.sql_dynamic_rename.stg_seed_sample_data", "compiled": true, "compiled_code": "-- read in the seed data (rememnber to dbt seed the source data in if you want to walk through the included example.)\n\nwith source as (\n\n    select \n\n        *\n\n    from TIL_PORTFOLIO_PROJECTS.EH_SQL_DYNAMIC_RENAME.rename_sample_data\n\n),\n\n-- add a source row number as this is important in lots of cases for using a sql query to create a mapping table for the headers.\n\ntransformed as (\n\n select \n\n        *,\n        row_number() over (order by null) as row_num\n\nfrom source\n\n)\n\nselect * from transformed", "relation_name": "TIL_PORTFOLIO_PROJECTS.EH_SQL_DYNAMIC_RENAME.stg_seed_sample_data"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-18T11:58:52.252979Z", "completed_at": "2024-07-18T11:58:52.276030Z"}, {"name": "execute", "started_at": "2024-07-18T11:58:52.276030Z", "completed_at": "2024-07-18T11:58:52.276030Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 0.02706313133239746, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.sql_dynamic_rename.int_seed_data_only_table", "compiled": true, "compiled_code": "-- take the staged data and in this example skip the first row so that we have a table with the original column names and the first row is now the first row that data actually starts.\n\nwith source as (\n\n    select * from TIL_PORTFOLIO_PROJECTS.EH_SQL_DYNAMIC_RENAME.stg_seed_sample_data\n\n),\n\n-- skip the nested header row\ntransformed as (\n\n    select\n\n        *\n\n    from source\n    where row_num > 1\n\n)\n\nselect * from transformed", "relation_name": "TIL_PORTFOLIO_PROJECTS.EH_SQL_DYNAMIC_RENAME.int_seed_data_only_table"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-18T11:58:52.256983Z", "completed_at": "2024-07-18T11:58:52.861679Z"}, {"name": "execute", "started_at": "2024-07-18T11:58:52.863642Z", "completed_at": "2024-07-18T11:58:52.863642Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.6734793186187744, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.sql_dynamic_rename.int_seed_header_mapping", "compiled": true, "compiled_code": "-- This is an example query for returning a mapping table for renaming columns and addressing the nested header issue.\n\n-- unpivot the staged model to get header name in the rows In this instance the excluded columns are not pivotted and .\n\nwith unpivot as (\n\n    select\n        employee,\n        row_num,\n\n      cast('OBSERVATION_START_TIME' as TEXT) as header,\n      cast(  \n           OBSERVATION_START_TIME\n             \n           as varchar) as subheader\n\n    from TIL_PORTFOLIO_PROJECTS.EH_SQL_DYNAMIC_RENAME.stg_seed_sample_data\n\n    union all\n    select\n        employee,\n        row_num,\n\n      cast('OBSERVATION_INTERVAL' as TEXT) as header,\n      cast(  \n           OBSERVATION_INTERVAL\n             \n           as varchar) as subheader\n\n    from TIL_PORTFOLIO_PROJECTS.EH_SQL_DYNAMIC_RENAME.stg_seed_sample_data\n\n    union all\n    select\n        employee,\n        row_num,\n\n      cast('OBSERVATION_LENGTH_MINS' as TEXT) as header,\n      cast(  \n           OBSERVATION_LENGTH_MINS\n             \n           as varchar) as subheader\n\n    from TIL_PORTFOLIO_PROJECTS.EH_SQL_DYNAMIC_RENAME.stg_seed_sample_data\n\n    union all\n    select\n        employee,\n        row_num,\n\n      cast('INTERACTION_WITH' as TEXT) as header,\n      cast(  \n           INTERACTION_WITH\n             \n           as varchar) as subheader\n\n    from TIL_PORTFOLIO_PROJECTS.EH_SQL_DYNAMIC_RENAME.stg_seed_sample_data\n\n    union all\n    select\n        employee,\n        row_num,\n\n      cast('F' as TEXT) as header,\n      cast(  \n           F\n             \n           as varchar) as subheader\n\n    from TIL_PORTFOLIO_PROJECTS.EH_SQL_DYNAMIC_RENAME.stg_seed_sample_data\n\n    union all\n    select\n        employee,\n        row_num,\n\n      cast('G' as TEXT) as header,\n      cast(  \n           G\n             \n           as varchar) as subheader\n\n    from TIL_PORTFOLIO_PROJECTS.EH_SQL_DYNAMIC_RENAME.stg_seed_sample_data\n\n    union all\n    select\n        employee,\n        row_num,\n\n      cast('H' as TEXT) as header,\n      cast(  \n           H\n             \n           as varchar) as subheader\n\n    from TIL_PORTFOLIO_PROJECTS.EH_SQL_DYNAMIC_RENAME.stg_seed_sample_data\n\n    union all\n    select\n        employee,\n        row_num,\n\n      cast('TASK_ENGAGEMENT' as TEXT) as header,\n      cast(  \n           TASK_ENGAGEMENT\n             \n           as varchar) as subheader\n\n    from TIL_PORTFOLIO_PROJECTS.EH_SQL_DYNAMIC_RENAME.stg_seed_sample_data\n\n    union all\n    select\n        employee,\n        row_num,\n\n      cast('J' as TEXT) as header,\n      cast(  \n           J\n             \n           as varchar) as subheader\n\n    from TIL_PORTFOLIO_PROJECTS.EH_SQL_DYNAMIC_RENAME.stg_seed_sample_data\n\n    union all\n    select\n        employee,\n        row_num,\n\n      cast('MANAGER_PROXIMITY' as TEXT) as header,\n      cast(  \n           MANAGER_PROXIMITY\n             \n           as varchar) as subheader\n\n    from TIL_PORTFOLIO_PROJECTS.EH_SQL_DYNAMIC_RENAME.stg_seed_sample_data\n\n    union all\n    select\n        employee,\n        row_num,\n\n      cast('L' as TEXT) as header,\n      cast(  \n           L\n             \n           as varchar) as subheader\n\n    from TIL_PORTFOLIO_PROJECTS.EH_SQL_DYNAMIC_RENAME.stg_seed_sample_data\n\n    union all\n    select\n        employee,\n        row_num,\n\n      cast('M' as TEXT) as header,\n      cast(  \n           M\n             \n           as varchar) as subheader\n\n    from TIL_PORTFOLIO_PROJECTS.EH_SQL_DYNAMIC_RENAME.stg_seed_sample_data\n\n    union all\n    select\n        employee,\n        row_num,\n\n      cast('N' as TEXT) as header,\n      cast(  \n           N\n             \n           as varchar) as subheader\n\n    from TIL_PORTFOLIO_PROJECTS.EH_SQL_DYNAMIC_RENAME.stg_seed_sample_data\n\n    \n    \n),\n\n-- only take row 1\noriginal_headers as(\n\n    select\n\n        row_number() over (order by null) as col_num,\n        header,      \n    \n    from unpivot\n    \n    where row_num = 1\n\n),\n\n-- Prep the headers that need to be renamed, in this case they are all length(1) so are changed to null so their info can be copied down and concatenated with the nested header value.\nheaders as (\n\n    select\n\n        row_num as rn,\n        case \n            when length(header) = 1 then null\n            else header\n        end as header,\n        subheader\n    \n    from unpivot\n    \n    where row_num = 1\n\n),\n\n-- copy down header value using last_value\nnew_headers as (\n    select\n\n        \n        row_number() over (order by null) as col_num,\n        case\n            when subheader is null then header \n            else coalesce(header, last_value(header) ignore nulls over (order by rn rows between unbounded preceding and current row)) || '_' || coalesce(subheader, '') \n        end as new_header,\n\n\n    from headers \n\n),\n\n-- sql databases do not like special characters in the table name so replace these with '_'\n\nrename_table as (\n\n    select\n\n        upper(regexp_replace(h.new_header, '[^A-Za-z0-9_]', '_')) as new_header,\n\n        original_headers.header\n\n    from new_headers h\n    inner join original_headers on h.col_num = original_headers.col_num\n\n)\n\n-- end result is a row for every column and THE ORDER IS IMPORTANT, we have new_header followed by original header.\n\nselect * from rename_table", "relation_name": "TIL_PORTFOLIO_PROJECTS.EH_SQL_DYNAMIC_RENAME.int_seed_header_mapping"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-18T11:58:52.931501Z", "completed_at": "2024-07-18T11:58:54.666529Z"}, {"name": "execute", "started_at": "2024-07-18T11:58:54.666529Z", "completed_at": "2024-07-18T11:58:54.666529Z"}], "thread_id": "Thread-3 (worker)", "execution_time": 1.8093979358673096, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.sql_dynamic_rename.int_seed__execute_rename", "compiled": true, "compiled_code": "-- as the rename macro has references back to models, we might have problems with unclear references.\n-- this can be avoided two ways, in this version, within the model itself before calling the macro we have added CTEs that refer to the two proceeding models that are needed in the macro. This ensures that this model and the macro within execute after the first two models (otherwise the macro within this model will try and execute before the models are created)\n\n-- the other approach is to tell dbt with a comment statement at the start of the model that specifies dependencies. Like so\n-- depends_on: TIL_PORTFOLIO_PROJECTS.EH_SQL_DYNAMIC_RENAME.int_seed_data_only_table\n\nwith data as (\n\n    select * from TIL_PORTFOLIO_PROJECTS.EH_SQL_DYNAMIC_RENAME.int_seed_data_only_table\n\n),\n\nheader_mapping as (\n\n    select * from TIL_PORTFOLIO_PROJECTS.EH_SQL_DYNAMIC_RENAME.int_seed_header_mapping\n\n),\n\n-- the macro returns a list of column_name1 as new_column_name1, column_name2 as new_column_name2 etc. that are then wrapped in the model with a select and a from for the data that is to be renamed. \n\nrenamed_table as (\n        \n        select\n\n            EMPLOYEE,\nOBSERVATION_START_TIME as OBSERVATION_START_TIME,\nOBSERVATION_INTERVAL as OBSERVATION_INTERVAL,\nOBSERVATION_LENGTH_MINS as OBSERVATION_LENGTH_MINS,\nINTERACTION_WITH as INTERACTION_WITH_MANAGER,\nF as INTERACTION_WITH_COWORKER,\nG as INTERACTION_WITH_CUSTOMER,\nH as INTERACTION_WITH_NO_ONE,\nTASK_ENGAGEMENT as TASK_ENGAGEMENT_ON_TASK,\nJ as TASK_ENGAGEMENT_OFF_TASK,\nMANAGER_PROXIMITY as MANAGER_PROXIMITY_NEXT_TO___2M_,\nL as MANAGER_PROXIMITY_CLOSE_TO___5M_,\nM as MANAGER_PROXIMITY_FURTHER__5M_,\nN as MANAGER_PROXIMITY_NA,\nROW_NUM\n\n        from data\n\n)\n\nselect * from renamed_table", "relation_name": "TIL_PORTFOLIO_PROJECTS.EH_SQL_DYNAMIC_RENAME.int_seed__execute_rename"}], "elapsed_time": 3.3251943588256836, "args": {"log_format_file": "debug", "log_level_file": "debug", "source_freshness_run_project_hooks": false, "strict_mode": false, "vars": {}, "exclude": [], "indirect_selection": "eager", "require_resource_names_without_spaces": false, "log_path": "C:\\Users\\EdwardHayter\\Documents\\Virtual_Environments\\sql_dynamic_rename\\logs", "version_check": true, "invocation_command": "dbt docs generate", "introspect": true, "log_file_max_bytes": 10485760, "static_parser": true, "write_json": true, "log_level": "info", "require_explicit_package_overrides_for_builtin_materializations": true, "compile": true, "project_dir": "C:\\Users\\EdwardHayter\\Documents\\Virtual_Environments\\sql_dynamic_rename", "enable_legacy_logger": false, "macro_debugging": false, "partial_parse": true, "select": [], "cache_selected_only": false, "partial_parse_file_diff": true, "populate_cache": true, "use_colors_file": true, "show_resource_report": false, "warn_error_options": {"include": [], "exclude": []}, "print": true, "printer_width": 80, "favor_state": false, "log_format": "default", "static": false, "send_anonymous_usage_stats": true, "which": "generate", "empty_catalog": false, "profiles_dir": "C:\\Users\\EdwardHayter\\.dbt", "use_colors": true, "quiet": false, "defer": false}}